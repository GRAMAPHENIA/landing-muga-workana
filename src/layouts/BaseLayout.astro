---
import '../styles/critical.css';
import siteConfig from '../config/site';
import CookieBanner from '../components/CookieBanner.astro';

const {
  title = siteConfig.title,
  description = siteConfig.description,
  image = siteConfig.seo.ogImage,
  noindex = false,
  keywords = siteConfig.seo.keywords,
} = Astro.props;


const canonicalURL = new URL(Astro.url.pathname, Astro.site);
// Solo dejar la declaración con fallback a siteConfig
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO Básico -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="author" content={siteConfig.author} />
    <link rel="canonical" href={canonicalURL.href} />
    <link rel="canonical" href={canonicalURL} />
    {noindex && <meta name="robots" content="noindex" />}

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url.href} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <meta property="og:site_name" content={siteConfig.name} />
    <meta property="og:locale" content="es_ES" />

    <!-- Twitter -->
    <meta property="twitter:card" content={siteConfig.seo.twitterCard} />
    <meta property="twitter:url" content={Astro.url.href} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={image} />
    <meta property="twitter:creator" content="@techsolutions_pro" />

    <!-- Preload recursos críticos -->

    
    <!-- DNS Prefetch para recursos externos -->
    <link rel="dns-prefetch" href="//www.googletagmanager.com">
    <link rel="dns-prefetch" href="//www.google-analytics.com">

    <!-- CSS crítico inline -->
    <style is:inline>
      :root{--color-primary:#000000;--color-secondary:#ffffff;--color-text:#111827;--color-text-light:#6b7280}
      html{scroll-behavior:smooth;overflow-x:hidden;scrollbar-gutter:stable}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-feature-settings:'cv02','cv03','cv04','cv11';color:var(--color-text);line-height:1.6;overflow-x:hidden;min-height:100vh;margin:0;padding:0}
      *{box-sizing:border-box}
      @media (min-width:768px){body{font-size:1.125rem}}
      @media (min-width:1024px){body{font-size:1rem}}
    </style>

    <!-- CSS no crítico con preload -->
    <link rel="preload" href="/src/styles/global.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/src/styles/global.css"></noscript>

    <!-- Google Analytics -->
    {siteConfig.seo.googleAnalytics && siteConfig.seo.googleAnalytics !== 'G-XXXXXXXXXX' && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${siteConfig.seo.googleAnalytics}`}></script>
        <script is:inline>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', siteConfig.seo.googleAnalytics);
        </script>
      </>
    )}

    <!-- Google Tag Manager -->
    {siteConfig.seo.googleTagManager && siteConfig.seo.googleTagManager !== 'GTM-XXXXXXX' && (
      <script is:inline>
        (function(w,d,s,l,i){
          w[l]=w[l]||[];
          w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
          const f=d.getElementsByTagName(s)[0],
                j=d.createElement(s),
                dl=l!='dataLayer'?`&l=${l}`:'';
          j.async=true;
          j.src=`https://www.googletagmanager.com/gtm.js?id=${i}${dl}`;
          f.parentNode.insertBefore(j,f);
        })(window, document, 'script', 'dataLayer', siteConfig.seo.googleTagManager);
      </script>
    )}
  </head>

  <body class="min-h-screen bg-white text-neutral-900 font-sans antialiased">
    <!-- Google Tag Manager (noscript) -->
    {siteConfig.seo.googleTagManager && siteConfig.seo.googleTagManager !== 'GTM-XXXXXXX' && (
      <noscript>
        <iframe src={`https://www.googletagmanager.com/ns.html?id=${siteConfig.seo.googleTagManager}`}
                height="0" width="0" style="display:none;visibility:hidden"></iframe>
      </noscript>
    )}

    <slot />

  <!-- Cookie Banner (comentado) -->
  {/** <CookieBanner /> */}

    <!-- Scripts optimizados -->
    <script src="/scripts/performance-optimizer.js" defer></script>
    <script src="/scripts/image-optimizer.js" defer></script>
    
    <script is:inline>
      // Performance observer para monitorear LCP
      if (typeof PerformanceObserver !== 'undefined') {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.entryType === 'largest-contentful-paint') {
              // Optimizar el elemento LCP si es necesario
              const lcpElement = entry.target || entry.element;
              if (lcpElement && lcpElement.tagName === 'IMG') {
                lcpElement.fetchPriority = 'high';
              }
            }
          }
        });
        observer.observe({ entryTypes: ['largest-contentful-paint'] });
      }

      // Prefetch de páginas importantes al hacer hover
      document.addEventListener('mouseover', function(e) {
        if (e.target && typeof e.target.closest === 'function') {
          const link = e.target.closest('a[href^="/"]');
          if (link && !link.dataset.prefetched) {
            const href = link.getAttribute('href');
            if (href && !href.startsWith('#')) {
              const prefetchLink = document.createElement('link');
              prefetchLink.rel = 'prefetch';
              prefetchLink.href = href;
              document.head.appendChild(prefetchLink);
              link.dataset.prefetched = 'true';
            }
          }
        }
      }, { passive: true });

      // Solo cargar WebSocket optimizer si es necesario
      if (window.location.pathname.includes('/chat') || 
          window.location.search.includes('realtime=true')) {
        const script = document.createElement('script');
        script.src = '/scripts/websocket-optimizer.js';
        script.defer = true;
        document.head.appendChild(script);
      }
    </script>
  </body>
</html>
